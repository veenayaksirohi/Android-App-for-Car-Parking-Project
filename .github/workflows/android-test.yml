name: Run Android App for 1 Minute
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-app:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '9477386'
          build-tools-version: '34.0.0'
          platform-version: '34'
          accept-licenses: true
          
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
        
      - name: Build APK
        run: ./gradlew assembleDebug
        
      - name: Enable KVM acceleration
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          
      - name: Create lightweight AVD
        run: |
          # Use Android 28 (faster boot) with minimal Google APIs
          sdkmanager "system-images;android-28;default;x86_64"
          echo "no" | avdmanager create avd -n test_device -k "system-images;android-28;default;x86_64" \
            --device "pixel_2" --force
          
      - name: Start emulator with maximum speed optimization
        run: |
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export PATH=$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools
          
          # Start emulator with aggressive speed optimizations
          $ANDROID_HOME/emulator/emulator -avd test_device \
            -no-window \
            -no-audio \
            -no-boot-anim \
            -no-snapshot \
            -no-skin \
            -camera-back none \
            -camera-front none \
            -memory 1536 \
            -partition-size 512 \
            -cores 2 \
            -accel on \
            -gpu swiftshader_indirect \
            -netdelay none \
            -netspeed full \
            -qemu -m 1536 &
            
          echo "Emulator started with PID: $!"
          
      - name: Wait for emulator (60s timeout)
        timeout-minutes: 1
        run: |
          echo "Waiting for emulator to boot (60s max)..."
          
          # Wait for ADB connection
          timeout 45s bash -c 'until adb devices | grep -q "emulator.*device"; do sleep 2; done'
          
          echo "ADB connected, waiting for boot..."
          
          # Wait for boot completion with shorter intervals
          for i in {1..15}; do
            boot_completed=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "0")
            animator_duration=$(adb shell settings get global animator_duration_scale 2>/dev/null || echo "1.0")
            
            if [ "$boot_completed" = "1" ] && [ "$animator_duration" != "null" ]; then
              echo "‚úÖ Emulator ready in $((i*3)) seconds"
              
              # Disable animations for faster interaction
              adb shell settings put global window_animation_scale 0
              adb shell settings put global transition_animation_scale 0
              adb shell settings put global animator_duration_scale 0
              
              # Unlock screen
              adb shell input keyevent 82
              sleep 1
              break
            fi
            
            if [ $i -eq 15 ]; then
              echo "‚ùå Emulator boot timeout after 45 seconds"
              adb devices -l
              adb shell getprop | grep boot
              exit 1
            fi
            
            echo "Boot check $i/15..."
            sleep 3
          done
          
      - name: Install and run app for 1 minute
        timeout-minutes: 2
        run: |
          # Build and install APK faster
          adb install -r app/build/outputs/apk/debug/app-debug.apk
          
          # Extract package info more efficiently
          PACKAGE_NAME=$(aapt dump badging app/build/outputs/apk/debug/app-debug.apk | head -1 | sed -n "s/.*name='\([^']*\)'.*/\1/p")
          MAIN_ACTIVITY=$(aapt dump badging app/build/outputs/apk/debug/app-debug.apk | grep "launchable-activity" | sed -n "s/.*name='\([^']*\)'.*/\1/p")
          
          echo "üì± Package: $PACKAGE_NAME"
          echo "üöÄ Activity: $MAIN_ACTIVITY"
          
          # Clear any previous app data and launch
          adb shell pm clear "$PACKAGE_NAME" 2>/dev/null || true
          adb shell am start -W -n "$PACKAGE_NAME/$MAIN_ACTIVITY"
          
          # Quick verification
          sleep 2
          if adb shell pidof "$PACKAGE_NAME" > /dev/null; then
            echo "‚úÖ App launched successfully"
          else
            echo "‚ùå App launch failed"
            adb logcat -d | tail -20
            exit 1
          fi
          
          # Run for exactly 60 seconds with minimal overhead
          echo "‚è±Ô∏è  Running app for 60 seconds..."
          start_time=$(date +%s)
          
          while true; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            
            if [ $elapsed -ge 60 ]; then
              echo "‚úÖ App completed 60-second run"
              break
            fi
            
            # Check app health every 10 seconds
            if [ $((elapsed % 10)) -eq 0 ] && [ $elapsed -gt 0 ]; then
              if adb shell pidof "$PACKAGE_NAME" > /dev/null; then
                echo "üì± App running... ${elapsed}s/60s"
                # Light interaction every 15 seconds
                if [ $((elapsed % 15)) -eq 0 ]; then
                  adb shell input tap 400 800 &
                fi
              else
                echo "‚ö†Ô∏è  App crashed at ${elapsed}s"
                adb logcat -d | tail -10
                break
              fi
            fi
            
            sleep 1
          done
          
      - name: Stop app
        run: |
          # Get package name again
          PACKAGE_NAME=$(aapt dump badging app/build/outputs/apk/debug/app-debug.apk | grep package | awk '{print $2}' | sed "s/name='\(.*\)'/\1/")
          
          echo "üõë Stopping app..."
          adb shell am force-stop "$PACKAGE_NAME"
          echo "App stopped"
          
      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          adb kill-server || true
          pkill -f emulator || true